<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SC Activity Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons (lighter than FontAwesome) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); transition: all 0.2s; }
        .card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Chat Animations */
        .chat-enter { animation: chatEnter 0.3s ease-out forwards; }
        @keyframes chatEnter { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i data-lucide="bar-chart-2" class="text-white h-6 w-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">SC Activity</h1>
                        <p class="text-xs text-gray-500">Solution Consulting Analytics</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="resetFilters()" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                        <i data-lucide="rotate-ccw" class="h-4 w-4"></i> Reset Filters
                    </button>
                    <div class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                        <span id="record-count">0</span> records
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Sidebar / Filter Panel -->
        <aside class="w-64 bg-white border-r border-gray-200 overflow-y-auto flex-shrink-0 z-0 hidden md:block">
            <div class="p-6 space-y-6">
                
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Date Range</label>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400 w-8">From</span>
                            <input type="date" id="filter-start-date" onchange="updateDashboard()" class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400 w-8">To</span>
                            <input type="date" id="filter-end-date" onchange="updateDashboard()" class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Team Member</label>
                    <select id="filter-assigned" onchange="updateDashboard()" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="All">All Members</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Account Owner</label>
                    <select id="filter-owner" onchange="updateDashboard()" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="All">All Owners</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Event Type</label>
                    <select id="filter-type" onchange="updateDashboard()" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="All">All Types</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Solution</label>
                    <select id="filter-solution" onchange="updateDashboard()" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="All">All Solutions</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-sm font-medium text-gray-900 mb-2">Insights</h3>
                    <p class="text-xs text-gray-500 leading-relaxed">
                        Activity is currently focused on <strong>Meeting Prep</strong> and <strong>Demo Support</strong>. 
                        <br><br>
                        <strong>Kenny Iannuzzi</strong> maintains the highest volume of recorded events in this period.
                    </p>
                </div>

            </div>
        </aside>

        <!-- Dashboard Content -->
        <main class="flex-1 overflow-y-auto bg-gray-50 p-6 custom-scrollbar">
            
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 fade-in">
                <div class="card p-5 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-medium text-gray-500 uppercase">Total Activities</p>
                            <h3 class="text-2xl font-bold text-gray-900 mt-1" id="kpi-total">0</h3>
                        </div>
                        <div class="p-2 bg-blue-50 rounded-lg">
                            <i data-lucide="activity" class="text-blue-600 h-5 w-5"></i>
                        </div>
                    </div>
                </div>
                <div class="card p-5 border-l-4 border-green-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-medium text-gray-500 uppercase">Unique Opps</p>
                            <h3 class="text-2xl font-bold text-gray-900 mt-1" id="kpi-opps">0</h3>
                        </div>
                        <div class="p-2 bg-green-50 rounded-lg">
                            <i data-lucide="target" class="text-green-600 h-5 w-5"></i>
                        </div>
                    </div>
                </div>
                <div class="card p-5 border-l-4 border-purple-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-medium text-gray-500 uppercase">Top Activity</p>
                            <h3 class="text-lg font-bold text-gray-900 mt-1 truncate w-32" id="kpi-top-type">-</h3>
                        </div>
                        <div class="p-2 bg-purple-50 rounded-lg">
                            <i data-lucide="calendar" class="text-purple-600 h-5 w-5"></i>
                        </div>
                    </div>
                </div>
                <div class="card p-5 border-l-4 border-orange-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-medium text-gray-500 uppercase">Top Solution</p>
                            <h3 class="text-lg font-bold text-gray-900 mt-1 truncate w-32" id="kpi-top-sol">-</h3>
                        </div>
                        <div class="p-2 bg-orange-50 rounded-lg">
                            <i data-lucide="zap" class="text-orange-600 h-5 w-5"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 fade-in" style="animation-delay: 0.1s;">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Activity by Team Member</h3>
                    <div class="relative h-64">
                        <canvas id="chart-assigned"></canvas>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Event Type Distribution</h3>
                    <div class="relative h-64 flex justify-center">
                        <canvas id="chart-type"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 fade-in" style="animation-delay: 0.2s;">
                <div class="card p-6 lg:col-span-2">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Weekly Activity Volume</h3>
                    <div class="relative h-64">
                        <canvas id="chart-timeline"></canvas>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Solutions</h3>
                    <div class="relative h-64">
                        <canvas id="chart-solutions"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="card overflow-hidden fade-in" style="animation-delay: 0.3s;">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">Detailed Activity Log</h3>
                    <input type="text" id="table-search" onkeyup="filterTable()" placeholder="Search opportunities..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 w-64">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Date</th>
                                <th scope="col" class="px-6 py-3">Assigned</th>
                                <th scope="col" class="px-6 py-3">Owner</th>
                                <th scope="col" class="px-6 py-3">Opportunity</th>
                                <th scope="col" class="px-6 py-3">Type</th>
                                <th scope="col" class="px-6 py-3">Solutions</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- Rows populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-gray-200 bg-gray-50 text-center">
                    <p class="text-xs text-gray-400">Showing filtered results</p>
                </div>
            </div>

            <div class="h-12"></div> <!-- Spacer -->
            
        </main>

        <!-- CHAT WIDGET -->
        <div id="chat-widget" class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
            <!-- Chat Window -->
            <div id="chat-window" class="hidden bg-white w-80 h-96 rounded-lg shadow-xl flex flex-col border border-gray-200 mb-4 chat-enter origin-bottom-right">
                <!-- Header -->
                <div class="bg-blue-600 p-4 rounded-t-lg flex justify-between items-center text-white">
                    <div class="flex items-center gap-2">
                        <i data-lucide="bot" class="w-4 h-4"></i>
                        <h3 class="font-semibold text-sm">Data Assistant</h3>
                    </div>
                    <button onclick="toggleChat()" class="hover:bg-blue-700 rounded p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <!-- Messages -->
                <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50">
                    <div class="bg-blue-100 text-blue-900 p-3 rounded-lg rounded-tl-none self-start text-sm max-w-[85%]">
                        Hi! I can help you analyze this data. Try asking:
                        <ul class="list-disc ml-4 mt-1 space-y-1">
                            <li>How many activities?</li>
                            <li>Who is most active?</li>
                            <li>Top solutions?</li>
                            <li>Who owns the most accounts?</li>
                        </ul>
                    </div>
                </div>
                <!-- Input -->
                <div class="p-3 border-t border-gray-200 bg-white rounded-b-lg">
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" onkeypress="handleEnter(event)" placeholder="Ask a question..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                        <button onclick="sendMessage()" class="bg-blue-600 text-white rounded-lg px-3 py-2 hover:bg-blue-700 transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
            
            <!-- Toggle Button -->
            <button onclick="toggleChat()" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg transition-transform hover:scale-105">
                <i data-lucide="message-square" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <script>
        // --- DATA ---
        // New embedded JSON data from report1768491789202.csv
        const rawData = [{"Opportunity": "Renewal: Carilion Clinic: System: Rounding (2026)", "Assigned": "Jason Crepeau", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-10-01", "Cipher Solution(s)": "Patient Rounding", "Account Owner": "Kendra Sheehan"}, {"Opportunity": "Inova Health: System Upsell: SSR & Flowsheets", "Assigned": "Jason Crepeau", "Event Sub-Type": "Technical Support", "Event Location": "Phone/Web", "Date": "2025-10-02", "Cipher Solution(s)": "None", "Account Owner": "Jen Thomas"}, {"Opportunity": "Inova Health: System Upsell: SSR & Flowsheets", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Technical Support", "Event Location": "Phone/Web", "Date": "2025-10-02", "Cipher Solution(s)": "Post-Discharge Communications; Self-Service Rounding", "Account Owner": "Jen Thomas"}, {"Opportunity": "ChristianaCare Health System - Self Service Rounding", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-10-02", "Cipher Solution(s)": "Post-Discharge Communications", "Account Owner": "Kendra Sheehan"}, {"Opportunity": "Froedert - Outreach, Rounding, SSR::Froedtert South", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Technical Support", "Event Location": "Phone/Web", "Date": "2025-10-06", "Cipher Solution(s)": "Post-Discharge Communications", "Account Owner": "Matt Dyer"}, {"Opportunity": "Carilion Health System - ED Post Discharge Outreach", "Assigned": "Jason Crepeau", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-10-07", "Cipher Solution(s)": "CipherOutreach", "Account Owner": "Kendra Sheehan"}, {"Opportunity": "Renewal: Christiana Care Health System: Rounding (2028)", "Assigned": "Jason Crepeau", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-10-07", "Cipher Solution(s)": "Secure Data Sharing; Staff Rounding", "Account Owner": "Kendra Sheehan"}, {"Opportunity": "Sarasota Memorial - MA&A::Sarasota Memorial Hospital", "Assigned": "Jason Crepeau", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-10-08", "Cipher Solution(s)": "None", "Account Owner": "Jen Thomas"}, {"Opportunity": "Sarasota Memorial - MA&A::Sarasota Memorial Hospital", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-10-08", "Cipher Solution(s)": "RxLink", "Account Owner": "Jen Thomas"}, {"Opportunity": "MD Anderson Cancer Center-RFP-PD Outreach::The University of Texas M.D. Anderson Cancer Center", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-10-08", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "CipherRounds::Crouse Hospital Health System", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-10-09", "Cipher Solution(s)": "Self-Service Rounding", "Account Owner": "Bob Fressola"}, {"Opportunity": "Unknown Opportunity", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Unknown", "Event Location": "", "Date": "2025-10-09", "Cipher Solution(s)": "None", "Account Owner": "Matt Dyer"}, {"Opportunity": "Renewal: NewYork-Presbyterian Healthcare System: Post Discharge Outreach (2027)", "Assigned": "Jason Crepeau", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-10-14", "Cipher Solution(s)": "None", "Account Owner": "Bob Fressola"}, {"Opportunity": "NewYork-Presbyterian: Post-Visit Outreach", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-10-14", "Cipher Solution(s)": "Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "Renewal: NewYork-Presbyterian Healthcare System: Post Discharge Outreach (2027)", "Assigned": "Jason Crepeau", "Event Sub-Type": "Technical Support", "Event Location": "Phone/Web", "Date": "2025-10-16", "Cipher Solution(s)": "None", "Account Owner": "Bob Fressola"}, {"Opportunity": "Henry Mayo: Post Discharge Outreach", "Assigned": "Jason Crepeau", "Event Sub-Type": "RFP/RFI Support", "Event Location": "Phone/Web", "Date": "2025-10-23", "Cipher Solution(s)": "None", "Account Owner": "Jason Yuhas"}, {"Opportunity": "Henry Mayo: Post Discharge Outreach", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Unknown", "Event Location": "Phone/Web", "Date": "2025-10-23", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Jason Yuhas"}, {"Opportunity": "Rounding:: Children's Hospital Los Angeles::Childrens Hospital Los Angeles", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-10-23", "Cipher Solution(s)": "Location Rounding; Patient Rounding; Self-Service Rounding", "Account Owner": "Chris Peak"}, {"Opportunity": "SDS::Middlesex Hospital", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Technical Support", "Event Location": "Phone/Web", "Date": "2025-10-27", "Cipher Solution(s)": "Secure Data Sharing", "Account Owner": "Bob Fressola"}, {"Opportunity": "Rounding:: Children's Hospital Los Angeles::Childrens Hospital Los Angeles", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-10-27", "Cipher Solution(s)": "Location Rounding; Patient Rounding", "Account Owner": "Chris Peak"}, {"Opportunity": "University of Missouri Hospital and Clinics: Rounding Expansion", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-10-27", "Cipher Solution(s)": "Patient Rounding", "Account Owner": "Kendra Sheehan"}, {"Opportunity": "AdventHealth - Patient Rounding & SSR", "Assigned": "Jason Crepeau", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-10-28", "Cipher Solution(s)": "None", "Account Owner": "Joe Grosso"}, {"Opportunity": "AdventHealth - PD Outreach", "Assigned": "Jason Crepeau", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-10-29", "Cipher Solution(s)": "CipherOutreach; RxLink", "Account Owner": "Joe Grosso"}, {"Opportunity": "Auto-Renewal: University of Missouri Hospital and Clinics: Rounding (2027)", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-10-29", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Kendra Sheehan"}, {"Opportunity": "Rounding:: Children's Hospital Los Angeles::Childrens Hospital Los Angeles", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-10-30", "Cipher Solution(s)": "Patient Rounding; Staff Rounding", "Account Owner": "Chris Peak"}, {"Opportunity": "Southcoast: Self-service rounding", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-10-30", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "PDO::Southcoast Health System", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-10-30", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "PDO::Southcoast Health System", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-10-31", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "Unknown Opportunity", "Assigned": "Jason Crepeau", "Event Sub-Type": "Unknown", "Event Location": "", "Date": "2025-10-31", "Cipher Solution(s)": "None", "Account Owner": "Jen Thomas"}, {"Opportunity": "Rounding:: Children's Hospital Los Angeles::Childrens Hospital Los Angeles", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-10-31", "Cipher Solution(s)": "Patient Rounding; Staff Rounding", "Account Owner": "Chris Peak"}, {"Opportunity": "PDO Expansion::Hartford HealthCare", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-11-06", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "PDO Expansion::Hartford HealthCare", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-11-10", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "Wellstar: TEAM Proms outreach::WellStar Health System", "Assigned": "Jason Crepeau", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-11-14", "Cipher Solution(s)": "PROMs Communications", "Account Owner": "Chris Peak"}, {"Opportunity": "PDO DRG::The University of Texas M.D. Anderson Cancer Center", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-11-14", "Cipher Solution(s)": "Secure Data Sharing", "Account Owner": "Bob Fressola"}, {"Opportunity": "Texas Childrens - PD Outreach::Texas Children's Hospital", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-11-17", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications; PROMs Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "PDO Expansion::Hartford HealthCare", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-11-18", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "UIH - Post-visit Ambulatory Outreach::University of Illinois Hospital", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-11-18", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Matt Dyer"}, {"Opportunity": "Unknown Opportunity", "Assigned": "Jason Crepeau", "Event Sub-Type": "Unknown", "Event Location": "", "Date": "2025-11-18", "Cipher Solution(s)": "None", "Account Owner": "Bob Fressola"}, {"Opportunity": "Wellstar: TEAM Proms outreach::WellStar Health System", "Assigned": "Jason Crepeau", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-11-20", "Cipher Solution(s)": "PROMs Communications", "Account Owner": "Chris Peak"}, {"Opportunity": "Meritus Medical Center: Patient Rounding", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-11-20", "Cipher Solution(s)": "Patient Rounding", "Account Owner": "Jason Yuhas"}, {"Opportunity": "Meritus Medical Center: Patient Rounding", "Assigned": "Jason Crepeau", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-11-21", "Cipher Solution(s)": "Patient Rounding", "Account Owner": "Jason Yuhas"}, {"Opportunity": "Renewal: Texas Childrens: System Rounding (2026)", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-11-21", "Cipher Solution(s)": "Patient Rounding; Self-Service Rounding", "Account Owner": "Bob Fressola"}, {"Opportunity": "PDO Expansion::Hartford HealthCare", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-11-21", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "PDO Expansion::Hartford HealthCare", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-11-24", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "PDO Expansion::Hartford HealthCare", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-11-25", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "Licking Memorial Hospital - Post Discharge Outreach & Staff/Location & Flowsheets", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-11-25", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Kendra Sheehan"}, {"Opportunity": "PDO Expansion::Hartford HealthCare", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-11-26", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Bob Fressola"}, {"Opportunity": "Unknown Opportunity", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Unknown", "Event Location": "", "Date": "2025-12-01", "Cipher Solution(s)": "None", "Account Owner": "Bob Fressola"}, {"Opportunity": "Post DIscharge Outreach::Community Regional Medical Center", "Assigned": "Jason Crepeau", "Event Sub-Type": "Technical Support", "Event Location": "Phone/Web", "Date": "2025-12-08", "Cipher Solution(s)": "None", "Account Owner": "Chris Peak"}, {"Opportunity": "Meritus Medical Center: Patient Rounding", "Assigned": "Jason Crepeau", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-12-10", "Cipher Solution(s)": "CipherOutreach", "Account Owner": "Jason Yuhas"}, {"Opportunity": "Meritus Medical Center: Patient Rounding", "Assigned": "Jason Crepeau", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-12-10", "Cipher Solution(s)": "CipherOutreach", "Account Owner": "Jason Yuhas"}, {"Opportunity": "PDO Expansion::Hartford HealthCare", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-12-10", "Cipher Solution(s)": "CipherOutreach", "Account Owner": "Bob Fressola"}, {"Opportunity": "Kaiser Permanente: National Contract for Remaining Markets", "Assigned": "Jason Crepeau", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-12-11", "Cipher Solution(s)": "CipherOutreach", "Account Owner": "Spenser Halvorsen"}, {"Opportunity": "Unknown Opportunity", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Discovery Support", "Event Location": "Phone/Web", "Date": "2025-12-12", "Cipher Solution(s)": "CipherOutreach", "Account Owner": "Ian Lomas"}, {"Opportunity": "Unknown Opportunity", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-12-15", "Cipher Solution(s)": "Post-Discharge Communications", "Account Owner": "Ian Lomas"}, {"Opportunity": "Unknown Opportunity", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-12-16", "Cipher Solution(s)": "CipherOutreach; Post-Discharge Communications", "Account Owner": "Ian Lomas"}, {"Opportunity": "OneBrooklyn - Self Service Rounding", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-12-16", "Cipher Solution(s)": "Patient Rounding; Self-Service Rounding", "Account Owner": "Kendra Sheehan"}, {"Opportunity": "PDO Expansion::Hartford HealthCare", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Unknown", "Event Location": "Phone/Web", "Date": "2025-12-16", "Cipher Solution(s)": "CipherOutreach", "Account Owner": "Bob Fressola"}, {"Opportunity": "Unknown Opportunity", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Unknown", "Event Location": "", "Date": "2025-12-16", "Cipher Solution(s)": "None", "Account Owner": "Ian Lomas"}, {"Opportunity": "UF - Rounding::University of Florida Health", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-12-22", "Cipher Solution(s)": "Location Rounding; Patient Rounding", "Account Owner": "Joe Grosso"}, {"Opportunity": "Sentara Healthcare - Northern VA Medical Center - Rounding Suite", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Meeting Prep", "Event Location": "Phone/Web", "Date": "2025-12-22", "Cipher Solution(s)": "Patient Rounding; Self-Service Rounding", "Account Owner": "Kendra Sheehan"}, {"Opportunity": "Sentara Healthcare - Northern VA Medical Center - Rounding Suite", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-12-23", "Cipher Solution(s)": "Patient Rounding; Self-Service Rounding", "Account Owner": "Kendra Sheehan"}, {"Opportunity": "ChristianaCare Health System - Self Service Rounding", "Assigned": "Kenny Iannuzzi", "Event Sub-Type": "Demo Support", "Event Location": "Phone/Web", "Date": "2025-12-30", "Cipher Solution(s)": "Staff Rounding", "Account Owner": "Kendra Sheehan"}];

        // --- CHART INSTANCES ---
        let chartAssigned = null;
        let chartType = null;
        let chartTimeline = null;
        let chartSolutions = null;

        // --- INIT ---
        window.onload = function() {
            lucide.createIcons();
            populateFilters();
            updateDashboard();
        };

        // --- FILTER POPULATION ---
        function populateFilters() {
            const assignedSet = new Set();
            const typeSet = new Set();
            const solutionSet = new Set();
            const ownerSet = new Set();

            rawData.forEach(row => {
                if (row.Assigned) assignedSet.add(row.Assigned);
                if (row["Event Sub-Type"] && row["Event Sub-Type"] !== 'Unknown') typeSet.add(row["Event Sub-Type"]);
                if (row["Account Owner"] && row["Account Owner"] !== 'Unknown') ownerSet.add(row["Account Owner"]);
                
                const sols = row["Cipher Solution(s)"].split(';');
                sols.forEach(s => {
                    const cleanS = s.trim();
                    if(cleanS && cleanS !== 'None') solutionSet.add(cleanS);
                });
            });

            populateSelect('filter-assigned', Array.from(assignedSet).sort());
            populateSelect('filter-type', Array.from(typeSet).sort());
            populateSelect('filter-solution', Array.from(solutionSet).sort());
            populateSelect('filter-owner', Array.from(ownerSet).sort());
        }

        function populateSelect(id, items) {
            const select = document.getElementById(id);
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.text = item;
                select.appendChild(option);
            });
        }

        function resetFilters() {
            document.getElementById('filter-assigned').value = 'All';
            document.getElementById('filter-type').value = 'All';
            document.getElementById('filter-solution').value = 'All';
            document.getElementById('filter-owner').value = 'All';
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            updateDashboard();
        }

        // --- MAIN UPDATE LOGIC ---
        function updateDashboard() {
            // 1. Filter Data
            const assignedFilter = document.getElementById('filter-assigned').value;
            const typeFilter = document.getElementById('filter-type').value;
            const solutionFilter = document.getElementById('filter-solution').value;
            const ownerFilter = document.getElementById('filter-owner').value;
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;

            const filteredData = rawData.filter(row => {
                const matchAssigned = assignedFilter === 'All' || row.Assigned === assignedFilter;
                const matchType = typeFilter === 'All' || row["Event Sub-Type"] === typeFilter;
                const matchSolution = solutionFilter === 'All' || row["Cipher Solution(s)"].includes(solutionFilter);
                const matchOwner = ownerFilter === 'All' || row["Account Owner"] === ownerFilter;
                
                let matchDate = true;
                if (startDate && row.Date < startDate) matchDate = false;
                if (endDate && row.Date > endDate) matchDate = false;

                return matchAssigned && matchType && matchSolution && matchOwner && matchDate;
            });

            // 2. Update KPIs
            document.getElementById('record-count').innerText = filteredData.length;
            document.getElementById('kpi-total').innerText = filteredData.length;
            
            const uniqueOpps = new Set(filteredData.map(r => r.Opportunity).filter(o => o && o !== 'Unknown Opportunity')).size;
            document.getElementById('kpi-opps').innerText = uniqueOpps;

            // Calc Top Activity
            const typeCounts = {};
            filteredData.forEach(r => {
                const t = r["Event Sub-Type"];
                if (t && t !== 'Unknown') typeCounts[t] = (typeCounts[t] || 0) + 1;
            });
            const topType = Object.entries(typeCounts).sort((a,b) => b[1] - a[1])[0];
            document.getElementById('kpi-top-type').innerText = topType ? topType[0] : '-';

            // Calc Top Solution
            const solCounts = {};
            filteredData.forEach(r => {
                const sols = r["Cipher Solution(s)"].split(';');
                sols.forEach(s => {
                    const cleanS = s.trim();
                    if(cleanS && cleanS !== 'None') solCounts[cleanS] = (solCounts[cleanS] || 0) + 1;
                });
            });
            const topSol = Object.entries(solCounts).sort((a,b) => b[1] - a[1])[0];
            document.getElementById('kpi-top-sol').innerText = topSol ? topSol[0] : '-';


            // 3. Update Charts
            renderCharts(filteredData, solCounts);

            // 4. Update Table
            renderTable(filteredData);
        }

        function renderCharts(data, globalSolCounts) {
            // -- Assigned Bar --
            const assignCounts = {};
            data.forEach(r => { if(r.Assigned) assignCounts[r.Assigned] = (assignCounts[r.Assigned] || 0) + 1; });
            const assignLabels = Object.keys(assignCounts);
            const assignValues = Object.values(assignCounts);

            updateChart('chart-assigned', 'bar', assignLabels, assignValues, 'Activities', ['#3b82f6', '#10b981', '#8b5cf6']);

            // -- Type Doughnut --
            const typeCounts = {};
            data.forEach(r => { if(r["Event Sub-Type"] && r["Event Sub-Type"] !== 'Unknown') typeCounts[r["Event Sub-Type"]] = (typeCounts[r["Event Sub-Type"]] || 0) + 1; });
            const typeLabels = Object.keys(typeCounts);
            const typeValues = Object.values(typeCounts);
            
            updateChart('chart-type', 'doughnut', typeLabels, typeValues, 'Events', 
                ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1']
            );

            // -- Timeline Line --
            const dateCounts = {};
            data.forEach(r => { 
                if(!r.Date) return;
                dateCounts[r.Date] = (dateCounts[r.Date] || 0) + 1; 
            });
            const sortedDates = Object.keys(dateCounts).sort();
            const dateValues = sortedDates.map(d => dateCounts[d]);

            updateChart('chart-timeline', 'line', sortedDates, dateValues, 'Activity Volume', '#10b981');

            // -- Solutions Bar --
            // Use the counts calculated in KPI step
            const sortedSols = Object.entries(globalSolCounts).sort((a,b) => b[1] - a[1]).slice(0, 8); // Top 8
            updateChart('chart-solutions', 'bar', sortedSols.map(s=>s[0]), sortedSols.map(s=>s[1]), 'Mentions', '#f59e0b');
        }

        function updateChart(canvasId, type, labels, data, label, colors) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Destroy existing
            if (canvasId === 'chart-assigned' && chartAssigned) chartAssigned.destroy();
            if (canvasId === 'chart-type' && chartType) chartType.destroy();
            if (canvasId === 'chart-timeline' && chartTimeline) chartTimeline.destroy();
            if (canvasId === 'chart-solutions' && chartSolutions) chartSolutions.destroy();

            const config = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: Array.isArray(colors) ? colors : colors,
                        borderColor: Array.isArray(colors) ? '#ffffff' : colors,
                        borderWidth: 1,
                        tension: 0.3,
                        fill: type === 'line' ? {target: 'origin', below: 'rgba(16, 185, 129, 0.1)'} : false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type === 'doughnut', position: 'bottom' }
                    },
                    scales: type !== 'doughnut' ? {
                        y: { beginAtZero: true, grid: { display: true, drawBorder: false } },
                        x: { grid: { display: false } }
                    } : {}
                }
            };

            const newChart = new Chart(ctx, config);

            // Reassign global var
            if (canvasId === 'chart-assigned') chartAssigned = newChart;
            if (canvasId === 'chart-type') chartType = newChart;
            if (canvasId === 'chart-timeline') chartTimeline = newChart;
            if (canvasId === 'chart-solutions') chartSolutions = newChart;
        }

        // --- TABLE RENDER ---
        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            // Sort by Date Descending
            const sortedData = [...data].sort((a, b) => new Date(b.Date) - new Date(a.Date));

            sortedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50 transition-colors";
                
                // Color code event types
                let typeBadge = 'bg-gray-100 text-gray-800';
                if(row["Event Sub-Type"] === 'Demo Support') typeBadge = 'bg-green-100 text-green-800';
                if(row["Event Sub-Type"] === 'Meeting Prep') typeBadge = 'bg-blue-100 text-blue-800';
                if(row["Event Sub-Type"] === 'Technical Support') typeBadge = 'bg-purple-100 text-purple-800';

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${row.Date}</td>
                    <td class="px-6 py-4">${row.Assigned}</td>
                    <td class="px-6 py-4 truncate max-w-[100px]" title="${row["Account Owner"]}">${row["Account Owner"]}</td>
                    <td class="px-6 py-4 truncate max-w-xs" title="${row.Opportunity}">${row.Opportunity || '<span class="text-gray-300 italic">No Opp Name</span>'}</td>
                    <td class="px-6 py-4"><span class="${typeBadge} text-xs font-medium px-2.5 py-0.5 rounded">${row["Event Sub-Type"]}</span></td>
                    <td class="px-6 py-4 truncate max-w-xs" title="${row["Cipher Solution(s)"]}">${row["Cipher Solution(s)"].replace(/;/g, ', ') || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterTable() {
            const input = document.getElementById('table-search');
            const filter = input.value.toLowerCase();
            const rows = document.getElementById('table-body').getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const oppCell = rows[i].getElementsByTagName('td')[3]; // Updated index for Opp Name
                if (oppCell) {
                    const txtValue = oppCell.textContent || oppCell.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        rows[i].style.display = "";
                    } else {
                        rows[i].style.display = "none";
                    }
                }       
            }
        }

        // --- CHATBOT LOGIC ---
        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.classList.toggle('hidden');
            if (!win.classList.contains('hidden')) {
                document.getElementById('chat-input').focus();
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            // Add User Message
            addMessage(msg, 'user');
            input.value = '';

            // Simulate thinking delay
            setTimeout(() => {
                const response = generateBotResponse(msg);
                addMessage(response, 'bot');
            }, 500);
        }

        function addMessage(text, sender) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            const isBot = sender === 'bot';
            
            div.className = isBot 
                ? "bg-white border border-gray-200 text-gray-800 p-3 rounded-lg rounded-tl-none self-start text-sm max-w-[85%] shadow-sm"
                : "bg-blue-600 text-white p-3 rounded-lg rounded-tr-none self-end text-sm max-w-[85%] shadow-sm ml-auto";
            
            div.innerHTML = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function generateBotResponse(input) {
            const lowerInput = input.toLowerCase();
            
            // Greetings
            if (lowerInput.includes('hello') || lowerInput.includes('hi')) {
                return "Hello! I'm ready to analyze your data. Ask me about activities, team members, solutions, or account owners.";
            }

            // 1. Team / Assigned Queries
            if (lowerInput.includes('who') && (lowerInput.includes('active') || lowerInput.includes('most'))) {
                 const counts = {};
                rawData.forEach(r => { if(r.Assigned) counts[r.Assigned] = (counts[r.Assigned] || 0) + 1; });
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                const top = sorted[0];
                return `<b>${top[0]}</b> is the most active team member with <b>${top[1]}</b> activities recorded.`;
            }
            
            // 2. Account Owner Queries
            if (lowerInput.includes('owner') || lowerInput.includes('account')) {
                const counts = {};
                rawData.forEach(r => { if(r["Account Owner"] && r["Account Owner"] !== 'Unknown') counts[r["Account Owner"]] = (counts[r["Account Owner"]] || 0) + 1; });
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                const top = sorted[0];
                
                return `<b>${top[0]}</b> is the busiest Account Owner with <b>${top[1]}</b> activities associated with their accounts.`;
            }

            // 3. Solutions Queries
            if (lowerInput.includes('solution') || lowerInput.includes('product')) {
                const counts = {};
                rawData.forEach(r => {
                    const sols = r["Cipher Solution(s)"].split(';');
                    sols.forEach(s => {
                        const cln = s.trim();
                        if(cln && cln !== 'None') counts[cln] = (counts[cln] || 0) + 1;
                    });
                });
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                const top3 = sorted.slice(0, 3).map(s => `<li>${s[0]} (${s[1]})</li>`).join('');
                
                return `The top discussed solutions are:<ul class='list-disc ml-4 mt-2 pl-2'>${top3}</ul>`;
            }

            // 4. Count/Total Queries
            if (lowerInput.includes('how many') || lowerInput.includes('total') || lowerInput.includes('count')) {
                const uniqueOpps = new Set(rawData.map(r => r.Opportunity)).size;
                return `I found a total of <b>${rawData.length}</b> activities across <b>${uniqueOpps}</b> unique opportunities.`;
            }

            // Default
            return "I'm not sure about that. Try asking 'Who is most active?', 'Total count?', or 'Top solutions'.";
        }
    </script>
</body>
</html>